/*
Deployment script for ArchDB

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "ArchDB"
:setvar DefaultFilePrefix "ArchDB"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key 7253a790-b57e-424c-a5a1-4a77e2491c09 is skipped, element [dbo].[Employee].[Id] (SqlSimpleColumn) will not be renamed to ID';


GO
PRINT N'Rename refactoring operation with key 78c611e9-9f76-4261-93a0-9689536c6add is skipped, element [dbo].[User].[Id] (SqlSimpleColumn) will not be renamed to ID';


GO
PRINT N'Rename refactoring operation with key 154f992c-347b-4906-bf7f-14a3e3dae602 is skipped, element [dbo].[Tokens].[Id] (SqlSimpleColumn) will not be renamed to ID';


GO
PRINT N'Creating [dbo].[Customers]...';


GO
CREATE TABLE [dbo].[Customers] (
    [ID]      UNIQUEIDENTIFIER NOT NULL,
    [Name]    VARCHAR (150)    NULL,
    [LogoUrl] NVARCHAR (MAX)   NULL,
    CONSTRAINT [PK_Customer] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Roles]...';


GO
CREATE TABLE [dbo].[Roles] (
    [ID]          UNIQUEIDENTIFIER NOT NULL,
    [Name]        VARCHAR (50)     NULL,
    [Description] VARCHAR (200)    NULL,
    [RolesSet]    NVARCHAR (MAX)   NULL,
    [Type]        INT              NULL,
    CONSTRAINT [PK_Roles] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Tokens]...';


GO
CREATE TABLE [dbo].[Tokens] (
    [ID]        UNIQUEIDENTIFIER NOT NULL,
    [UserID]    UNIQUEIDENTIFIER NULL,
    [AuthToken] NVARCHAR (MAX)   NULL,
    [IssuedOn]  DATETIME         NULL,
    [ExpiresOn] DATETIME         NULL,
    PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating [dbo].[UserGroupInRoles]...';


GO
CREATE TABLE [dbo].[UserGroupInRoles] (
    [ID]          UNIQUEIDENTIFIER NOT NULL,
    [UserGroupID] UNIQUEIDENTIFIER NULL,
    [RoleID]      UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_UserGroupInRoles] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[UserGroups]...';


GO
CREATE TABLE [dbo].[UserGroups] (
    [ID]          UNIQUEIDENTIFIER NOT NULL,
    [Name]        VARCHAR (50)     NULL,
    [Description] VARCHAR (200)    NULL,
    CONSTRAINT [PK_UserGroups] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[UserInGroups]...';


GO
CREATE TABLE [dbo].[UserInGroups] (
    [ID]          UNIQUEIDENTIFIER NOT NULL,
    [UserGroupID] UNIQUEIDENTIFIER NULL,
    [UserID]      UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_UserInGroups] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[UserInRoles]...';


GO
CREATE TABLE [dbo].[UserInRoles] (
    [ID]     UNIQUEIDENTIFIER NOT NULL,
    [UserID] UNIQUEIDENTIFIER NULL,
    [RoleID] UNIQUEIDENTIFIER NULL,
    CONSTRAINT [PK_UserInRoles] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[UserProfiles]...';


GO
CREATE TABLE [dbo].[UserProfiles] (
    [ID]        UNIQUEIDENTIFIER NOT NULL,
    [UserID]    UNIQUEIDENTIFIER NOT NULL,
    [FirstName] VARCHAR (50)     NULL,
    [LastName]  VARCHAR (50)     NULL,
    [Mobile]    VARCHAR (15)     NULL,
    [ImageUrl]  NVARCHAR (MAX)   NULL,
    CONSTRAINT [PK_UserProfile] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];


GO
PRINT N'Creating [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [ID]               UNIQUEIDENTIFIER NOT NULL,
    [CutomerID]        UNIQUEIDENTIFIER NOT NULL,
    [Email]            NVARCHAR (50)    NULL,
    [Password]         NVARCHAR (150)   NULL,
    [ActivationStatus] INT              NULL,
    [IsActive]         BIT              NULL,
    CONSTRAINT [PK__User__3214EC2744C21FF4] PRIMARY KEY CLUSTERED ([ID] ASC) ON [PRIMARY]
) ON [PRIMARY];


GO
PRINT N'Creating [dbo].[FK_Tokens_Users]...';


GO
ALTER TABLE [dbo].[Tokens] WITH NOCHECK
    ADD CONSTRAINT [FK_Tokens_Users] FOREIGN KEY ([UserID]) REFERENCES [dbo].[Users] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserGroupInRoles_Roles]...';


GO
ALTER TABLE [dbo].[UserGroupInRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_UserGroupInRoles_Roles] FOREIGN KEY ([RoleID]) REFERENCES [dbo].[Roles] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserGroupInRoles_UserGroups]...';


GO
ALTER TABLE [dbo].[UserGroupInRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_UserGroupInRoles_UserGroups] FOREIGN KEY ([UserGroupID]) REFERENCES [dbo].[UserGroups] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserInGroups_UserGroups]...';


GO
ALTER TABLE [dbo].[UserInGroups] WITH NOCHECK
    ADD CONSTRAINT [FK_UserInGroups_UserGroups] FOREIGN KEY ([UserGroupID]) REFERENCES [dbo].[UserGroups] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserInGroups_Users]...';


GO
ALTER TABLE [dbo].[UserInGroups] WITH NOCHECK
    ADD CONSTRAINT [FK_UserInGroups_Users] FOREIGN KEY ([UserID]) REFERENCES [dbo].[Users] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserInRoles_Roles]...';


GO
ALTER TABLE [dbo].[UserInRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_UserInRoles_Roles] FOREIGN KEY ([RoleID]) REFERENCES [dbo].[Roles] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserInRoles_Users]...';


GO
ALTER TABLE [dbo].[UserInRoles] WITH NOCHECK
    ADD CONSTRAINT [FK_UserInRoles_Users] FOREIGN KEY ([UserID]) REFERENCES [dbo].[Users] ([ID]);


GO
PRINT N'Creating [dbo].[FK_UserProfiles_Users]...';


GO
ALTER TABLE [dbo].[UserProfiles] WITH NOCHECK
    ADD CONSTRAINT [FK_UserProfiles_Users] FOREIGN KEY ([UserID]) REFERENCES [dbo].[Users] ([ID]);


GO
PRINT N'Creating [dbo].[FK_Users_Customers]...';


GO
ALTER TABLE [dbo].[Users] WITH NOCHECK
    ADD CONSTRAINT [FK_Users_Customers] FOREIGN KEY ([CutomerID]) REFERENCES [dbo].[Customers] ([ID]);


GO
-- Refactoring step to update target server with deployed transaction logs

IF OBJECT_ID(N'dbo.__RefactorLog') IS NULL
BEGIN
    CREATE TABLE [dbo].[__RefactorLog] (OperationKey UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    EXEC sp_addextendedproperty N'microsoft_database_tools_support', N'refactoring log', N'schema', N'dbo', N'table', N'__RefactorLog'
END
GO
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '7253a790-b57e-424c-a5a1-4a77e2491c09')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('7253a790-b57e-424c-a5a1-4a77e2491c09')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '78c611e9-9f76-4261-93a0-9689536c6add')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('78c611e9-9f76-4261-93a0-9689536c6add')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '154f992c-347b-4906-bf7f-14a3e3dae602')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('154f992c-347b-4906-bf7f-14a3e3dae602')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Tokens] WITH CHECK CHECK CONSTRAINT [FK_Tokens_Users];

ALTER TABLE [dbo].[UserGroupInRoles] WITH CHECK CHECK CONSTRAINT [FK_UserGroupInRoles_Roles];

ALTER TABLE [dbo].[UserGroupInRoles] WITH CHECK CHECK CONSTRAINT [FK_UserGroupInRoles_UserGroups];

ALTER TABLE [dbo].[UserInGroups] WITH CHECK CHECK CONSTRAINT [FK_UserInGroups_UserGroups];

ALTER TABLE [dbo].[UserInGroups] WITH CHECK CHECK CONSTRAINT [FK_UserInGroups_Users];

ALTER TABLE [dbo].[UserInRoles] WITH CHECK CHECK CONSTRAINT [FK_UserInRoles_Roles];

ALTER TABLE [dbo].[UserInRoles] WITH CHECK CHECK CONSTRAINT [FK_UserInRoles_Users];

ALTER TABLE [dbo].[UserProfiles] WITH CHECK CHECK CONSTRAINT [FK_UserProfiles_Users];

ALTER TABLE [dbo].[Users] WITH CHECK CHECK CONSTRAINT [FK_Users_Customers];


GO
PRINT N'Update complete.';


GO
